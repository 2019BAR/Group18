---
title: "期末資料探索"
author: "第18組"
date: "2019/6/5"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readr)
library(dplyr)
```

```{r}
Z = read_csv("./ta_feng_all_months_merged.csv") %>%
  setNames(c("date","cust","age","area","cat","prod","qty","cost","price"))
Z$date = as.Date(Z$date, format="%m/%d/%Y")
Z$age[is.na(Z$age)] = "na"
Z$age = factor(Z$age, levels=c(
  "<25","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64",">65","na"), labels=c(
  "a20","a25","a30","a35","a40","a45","a50","a55","a60","a65","na"
  )) %>% as.character
# Z$area = paste0("z",Z$area)
summary(Z)
```

```{r}
# Quantile of Variables
sapply(Z[,7:9], quantile, prob=c(.99, .999, .9995))
# Remove Outliers
Z = subset(Z, qty<=24 & cost<=3800 & price<=4000) 
nrow(Z)
Z$tid = group_indices(Z, date, cust) # same customer same day
```

```{r}
# 計算數量
# No. cust, cat, prod, tid
sapply(Z[c("cust","cat","prod","tid")], n_distinct)
```

```{r}
# 整理交易資料成單一資料
#因爲同一個顧客購買兩個商品會是兩筆明細
X = Z %>% group_by(tid) %>% summarise(
  date = date[1],             # 交易日期  
  cust = cust[1],             # 顧客 ID
  age = age[1],               # 顧客 年齡級別
  area = area[1],             # 顧客 居住區別
  items = n(),                # 交易項目(總)數
  pieces = sum(qty),          # 產品(總)件數
  total = sum(price),         # 交易(總)金額
  gross = sum(price - cost)   # 毛利
  ) %>% data.frame
nrow(X) # 119422 
```

```{r}
# 處理離群值
# Check Quantile & Remove Outliers
sapply(X[,6:9], quantile, prob=c(.999, .9995, .9999))
# Remove Outliers
X = subset(X, items<=62 & pieces<95 & total<16000) # 119328
```

```{r}
# 產生客戶屬性的資料
# 一個客戶這4個月在這間店消費的屬性
d0 = max(X$date) + 1
A = X %>% mutate(
  days = as.integer(difftime(d0, date, units="days"))
  ) %>% 
  group_by(cust) %>% summarise(
    r = min(days),      # recency 最近一次距今購買天數
    s = max(days),      # seniority 第一次距今購買天數
    f = n(),            # frquency 總共買幾次
    m = mean(total),    # monetary 平均購買金額
    rev = sum(total),   # total revenue contribution 總收益
    raw = sum(gross),   # total gross profit contribution 總毛利
    age = age[1],       # age group 年齡
    area = area[1],     # area code 地區
  )     # 33241
nrow(A)
```

```{r}
hc = A[,2:4]  %>% dist %>% hclust(method = "ward.D2")
plot(hc)
k =7
rect.hclust(hc, k=k, border="red")

```

```{r}
g = cutree(hc,k=k)
A$cut2_4_7 = g
```

```{r}
save(A, file="./cut_A.rdata")
save(X, file="./X.rdata")
save(Z, file="./Z.rdata")
```

